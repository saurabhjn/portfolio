{% extends "base.html" %}

{% block title %}Portfolio Growth Graph{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">Portfolio Growth Over Time</h1>
            
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Investment Growth Timeline</h5>
                    <div class="btn-group mt-2 mb-2" role="group">
                        <a href="{{ url_for('portfolio_graph', range='3m') }}" class="btn btn-sm {% if selected_range == '3m' %}btn-primary{% else %}btn-outline-primary{% endif %}">3 Months</a>
                        <a href="{{ url_for('portfolio_graph', range='6m') }}" class="btn btn-sm {% if selected_range == '6m' %}btn-primary{% else %}btn-outline-primary{% endif %}">6 Months</a>
                        <a href="{{ url_for('portfolio_graph', range='1y') }}" class="btn btn-sm {% if selected_range == '1y' %}btn-primary{% else %}btn-outline-primary{% endif %}">1 Year</a>
                        <a href="{{ url_for('portfolio_graph', range='all') }}" class="btn btn-sm {% if selected_range == 'all' %}btn-primary{% else %}btn-outline-primary{% endif %}">All Time</a>
                    </div>
                    <div class="alert alert-info mt-2 mb-2" role="alert">
                        <strong>How to read this graph:</strong><br>
                        <span style="color: #28a745;">●</span> <strong>Green area</strong> = Total portfolio value (your money + market gains)<br>
                        <span style="color: #dc3545;">●</span> <strong>Red area</strong> = Money you invested (no gains included)<br>
                        <strong>The gap between them = Market gains</strong> - The wider the gap, the more the market has grown your investments.
                    </div>
                    <div class="mt-2">
                        <small class="text-info" id="chartInfo">Loading chart data...</small>
                    </div>
                </div>
                <div class="card-body">
                    <canvas id="portfolioChart" width="400" height="200"></canvas>
                </div>
            </div>
            
            <div class="mt-3">
                <a href="{{ url_for('index') }}" class="btn btn-secondary">← Back to Portfolio</a>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('portfolioChart').getContext('2d');
    const chartData = {{ chart_data | tojson }};
    
    if (!chartData || !chartData.total_value || !chartData.invested_amount) {
        document.getElementById('chartInfo').textContent = 'No chart data available';
        return;
    }
    
    const totalValueData = chartData.total_value || [];
    const investedData = chartData.invested_amount || [];
    
    document.getElementById('chartInfo').textContent = 
        `Showing ${totalValueData.length} data points`;
    
    if (totalValueData.length === 0) {
        document.getElementById('chartInfo').textContent = 'No data points to display';
        return;
    }
    
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            datasets: [
                {
                    label: 'Total Portfolio Value',
                    data: totalValueData,
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    pointRadius: 2,
                    pointHoverRadius: 4,
                    fill: true,
                    tension: 0.1
                },
                {
                    label: 'Money Invested (No Gains)',
                    data: investedData,
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    pointRadius: 2,
                    pointHoverRadius: 4,
                    fill: true,
                    tension: 0.1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: 'month'
                    },
                    title: {
                        display: true,
                        text: 'Date'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Portfolio Value (INR)'
                    },
                    ticks: {
                        callback: function(value) {
                            // Format large numbers in Indian style (lakhs/crores)
                            if (value >= 10000000) {
                                return '₹' + (value / 10000000).toFixed(1) + 'Cr';
                            } else if (value >= 100000) {
                                return '₹' + (value / 100000).toFixed(1) + 'L';
                            } else {
                                return '₹' + value.toLocaleString('en-IN');
                            }
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            const dataPoint = context[0].raw;
                            return dataPoint.event || 'Portfolio Update';
                        },
                        label: function(context) {
                            const value = context.parsed.y;
                            let formattedValue;
                            if (value >= 10000000) {
                                formattedValue = '₹' + (value / 10000000).toFixed(2) + ' Crores';
                            } else if (value >= 100000) {
                                formattedValue = '₹' + (value / 100000).toFixed(2) + ' Lakhs';
                            } else {
                                formattedValue = '₹' + value.toLocaleString('en-IN');
                            }
                            return formattedValue;
                        }
                    }
                },
                legend: {
                    display: true,
                    position: 'top'
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        }
    });
    
    // Set chart height
    document.getElementById('portfolioChart').style.height = '400px';
});
</script>
{% endblock %}